<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartStock Mobile</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; }
        body { background-color: var(--bg); font-family: 'Segoe UI', system-ui, sans-serif; padding-bottom: 80px; }
        
        /* Mobile Bottom Nav */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; height: 65px;
            background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1050; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-icon { text-align: center; color: #64748b; font-size: 0.8rem; cursor: pointer; flex: 1; }
        .nav-icon i { font-size: 1.4rem; display: block; margin-bottom: 2px; }
        .nav-icon.active { color: var(--primary); font-weight: 600; }
        
        /* Desktop Nav - Hidden on mobile */
        @media (max-width: 768px) { .desktop-nav { display: none !important; } }
        @media (min-width: 769px) { .bottom-nav { display: none !important; } }

        /* Cards & UI */
        .stat-card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; border: none; }
        .btn-floating { position: fixed; bottom: 80px; left: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 12px rgba(37,99,235,0.4); z-index: 1000; }
        
        /* Cart Bar */
        #cart-bar { position: fixed; bottom: 65px; left: 0; right: 0; background: #1e293b; color: white; padding: 12px 20px; z-index: 1040; transform: translateY(200%); transition: transform 0.3s; display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0; }
        #cart-bar.visible { transform: translateY(0); }
        
        .abc-badge-A { background: #d1fae5; color: #065f46; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        .abc-badge-B { background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        .abc-badge-C { background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="auth-section" class="container mt-5">
        <div class="stat-card mx-auto" style="max-width: 400px;">
            <h2 class="text-center text-primary fw-bold mb-4"><i class="fas fa-cubes"></i> SmartStock</h2>
            <ul class="nav nav-tabs nav-fill mb-3">
                <li class="nav-item"><a class="nav-link active" onclick="toggleAuth('login')" href="#">×›× ×™×¡×”</a></li>
                <li class="nav-item"><a class="nav-link" onclick="toggleAuth('register')" href="#">×”×¨×©××”</a></li>
            </ul>
            <div id="form-login">
                <input type="email" id="l-email" class="form-control mb-3" placeholder="××™××™×™×œ">
                <input type="password" id="l-pass" class="form-control mb-3" placeholder="×¡×™×¡××”">
                <button class="btn btn-primary w-100 py-2 fw-bold" onclick="login()">×”×ª×—×‘×¨ ×œ××¢×¨×›×ª</button>
            </div>
            <div id="form-register" class="d-none">
                <input type="text" id="r-name" class="form-control mb-3" placeholder="×©× ×”×¢×¡×§">
                <input type="email" id="r-email" class="form-control mb-3" placeholder="××™××™×™×œ">
                <input type="password" id="r-pass" class="form-control mb-3" placeholder="×¡×™×¡××”">
                <button class="btn btn-success w-100 py-2 fw-bold" onclick="register()">×¦×•×¨ ×—×©×‘×•×Ÿ ×—×“×©</button>
            </div>
            <p id="auth-msg" class="text-center mt-3"></p>
        </div>
    </div>

    <div id="app-section" class="d-none">
        <nav class="navbar navbar-expand navbar-dark bg-primary desktop-nav mb-4">
            <div class="container">
                <a class="navbar-brand fw-bold" href="#"><i class="fas fa-cubes"></i> SmartStock Pro</a>
                <div class="navbar-nav ms-auto">
                    <a class="nav-link active" onclick="switchTab('dashboard')">×“×©×‘×•×¨×“</a>
                    <a class="nav-link" onclick="switchTab('analytics')">×× ×œ×™×˜×™×§×¡ (AI)</a>
                    <a class="nav-link" onclick="switchTab('customers')">×œ×§×•×—×•×ª</a>
                    <a class="nav-link" onclick="switchTab('orders')">×”×–×× ×•×ª</a>
                    <button class="btn btn-sm btn-light text-primary fw-bold ms-3" onclick="logout()">×™×¦×™××”</button>
                </div>
            </div>
        </nav>

        <div class="d-md-none bg-primary text-white p-3 mb-3 d-flex justify-content-between align-items-center">
            <span class="fw-bold h5 m-0" id="mobile-title">×“×©×‘×•×¨×“</span>
            <i class="fas fa-sign-out-alt" onclick="logout()"></i>
        </div>

        <div class="container">
            
            <div id="tab-dashboard">
                <div class="row g-2 mb-3">
                    <div class="col-6"><div class="stat-card p-3"><div class="text-muted small">××›×™×¨×•×ª ×”×™×•×</div><h4 class="fw-bold m-0" id="kpi-sales">â‚ª0</h4></div></div>
                    <div class="col-6"><div class="stat-card p-3"><div class="text-muted small">×¨×•×•×— ××©×•×¢×¨</div><h4 class="fw-bold text-success m-0" id="kpi-profit">â‚ª0</h4></div></div>
                </div>

                <div class="d-flex gap-2 mb-3">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0" onclick="startScanner()"><i class="fas fa-barcode text-dark"></i></span>
                        <input type="text" id="search" class="form-control border-start-0" placeholder="×—×™×¤×•×© / ×¡×¨×™×§×”..." onkeyup="filterProds()">
                    </div>
                    <button class="btn btn-primary" onclick="openProdModal()"><i class="fas fa-plus"></i></button>
                </div>

                <div id="product-grid" class="row g-3"></div>
            </div>

            <div id="tab-analytics" class="d-none">
                <div class="stat-card">
                    <h5 class="fw-bold mb-3">ğŸ“Š × ×™×ª×•×— ABC (×¤××¨×˜×•)</h5>
                    <p class="small text-muted">×”××•×¦×¨×™× ×©××›× ×™×¡×™× ×”×›×™ ×”×¨×‘×” ×›×¡×£</p>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead><tr><th>××•×¦×¨</th><th>×”×›× ×¡×•×ª</th><th>×“×™×¨×•×’</th></tr></thead>
                            <tbody id="abc-list"></tbody>
                        </table>
                    </div>
                </div>
                <div class="stat-card mt-3 border-danger border-start border-4">
                    <h5 class="fw-bold mb-3 text-danger">âš ï¸ ×ª×—×–×™×ª ×’××¨ ××œ××™</h5>
                    <p class="small text-muted">××ª×™ ×”××œ××™ ×™×™×’××¨ ×œ×¤×™ ×§×¦×‘ ×”××›×™×¨×•×ª?</p>
                    <ul class="list-group list-group-flush" id="forecast-list"></ul>
                </div>
            </div>

            <div id="tab-customers" class="d-none">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>×œ×§×•×—×•×ª</h5>
                    <button class="btn btn-sm btn-success" onclick="openCustModal()">+ ×—×“×©</button>
                </div>
                <div class="list-group" id="cust-list"></div>
            </div>

            <div id="tab-orders" class="d-none">
                <h5>×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª</h5>
                <div class="list-group mt-3" id="order-list"></div>
            </div>
        </div>

        <div id="cart-bar">
            <div><span class="fw-bold" id="cart-total">â‚ª0</span> <small id="cart-count">(0 ×¤×¨×™×˜×™×)</small></div>
            <button class="btn btn-light btn-sm fw-bold text-dark" onclick="openCheckout()">×œ×§×•×¤×” <i class="fas fa-chevron-left"></i></button>
        </div>

        <div class="bottom-nav d-md-none">
            <div class="nav-icon active" onclick="switchTab('dashboard')" id="btn-dashboard"><i class="fas fa-home"></i>×‘×™×ª</div>
            <div class="nav-icon" onclick="switchTab('analytics')" id="btn-analytics"><i class="fas fa-chart-pie"></i>×“×•×—×•×ª</div>
            <div class="nav-icon" onclick="switchTab('orders')" id="btn-orders"><i class="fas fa-receipt"></i>×”×–×× ×•×ª</div>
            <div class="nav-icon" onclick="switchTab('customers')" id="btn-customers"><i class="fas fa-users"></i>×œ×§×•×—×•×ª</div>
        </div>
    </div>

    <div class="modal fade" id="scannerModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">×¡×¨×•×§ ×‘×¨×§×•×“</h5><button type="button" class="btn-close" data-bs-dismiss="modal" onclick="stopScanner()"></button></div><div class="modal-body p-0"><div id="reader" style="width: 100%;"></div></div></div></div></div>

    <div class="modal fade" id="checkoutModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">×¡×’×™×¨×ª ×—×©×‘×•×Ÿ</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body">
        <div class="mb-3">
            <label class="form-label">×œ×§×•×—</label>
            <select id="co-cust" class="form-select"></select>
        </div>
        <div class="mb-3">
            <label class="form-label">×××¦×¢×™ ×ª×©×œ×•×</label>
            <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="payment" id="pay-cash" value="××–×•××Ÿ" checked><label class="btn btn-outline-primary" for="pay-cash">ğŸ’µ ××–×•××Ÿ</label>
                <input type="radio" class="btn-check" name="payment" id="pay-card" value="××©×¨××™"><label class="btn btn-outline-primary" for="pay-card">ğŸ’³ ××©×¨××™</label>
                <input type="radio" class="btn-check" name="payment" id="pay-bit" value="Bit"><label class="btn btn-outline-primary" for="pay-bit">ğŸ“± Bit</label>
            </div>
        </div>
        <ul class="list-group list-group-flush mb-3 small" id="co-items"></ul>
        <div class="d-flex justify-content-between h4 fw-bold"><span>×¡×”"×›:</span><span id="co-total"></span></div>
        <button class="btn btn-success w-100 py-2 mt-3 fw-bold" onclick="submitOrder()">âœ… ××©×¨ ×”×–×× ×”</button>
    </div></div></div></div>

    <div class="modal fade" id="receiptModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body text-center py-4">
        <div class="text-success mb-3" style="font-size: 3rem;"><i class="fas fa-check-circle"></i></div>
        <h4>×”×–×× ×” ×‘×•×¦×¢×”!</h4>
        <p class="text-muted">××¡×¤×¨ ×”×–×× ×”: <span id="rec-oid"></span></p>
        <button class="btn btn-success w-100 mb-2" onclick="shareWhatsApp()"><i class="fab fa-whatsapp"></i> ×©×œ×— ×§×‘×œ×” ×œ×œ×§×•×—</button>
        <button class="btn btn-outline-secondary w-100" data-bs-dismiss="modal">×¡×’×•×¨</button>
    </div></div></div></div>

    <div class="modal fade" id="prodModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-body">
        <h5 class="mb-3">××•×¦×¨ ×—×“×©</h5>
        <input type="text" id="p-name" class="form-control mb-2" placeholder="×©× ×”××•×¦×¨">
        <input type="text" id="p-sku" class="form-control mb-2" placeholder="×‘×¨×§×•×“ / ××§×´×˜">
        <div class="row g-2">
            <div class="col"><input type="number" id="p-price" class="form-control" placeholder="××—×™×¨ ××›×™×¨×”"></div>
            <div class="col"><input type="number" id="p-cost" class="form-control" placeholder="××—×™×¨ ×¢×œ×•×ª"></div>
        </div>
        <input type="number" id="p-qty" class="form-control mt-2" placeholder="×›××•×ª ×‘××œ××™">
        <button class="btn btn-primary w-100 mt-3" onclick="saveProd()">×©××•×¨</button>
    </div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API = "https://smartstock-mag6.onrender.com"; // ×•×•×“× ×›×ª×•×‘×ª!
        let token = localStorage.getItem('token'), prods=[], custs=[], cart={}, lastOrder={};
        let html5QrcodeScanner;

        if(token) init();
        else document.getElementById('auth-section').classList.remove('d-none');

        function toggleAuth(type) {
            document.getElementById('form-login').classList.toggle('d-none', type!=='login');
            document.getElementById('form-register').classList.toggle('d-none', type!=='register');
            document.querySelectorAll('.nav-tabs .nav-link').forEach(l => l.classList.toggle('active'));
        }

        async function login() {
            const res = await fetch(`${API}/login`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email:document.getElementById('l-email').value,password:document.getElementById('l-pass').value})});
            const d = await res.json();
            if(res.ok) { localStorage.setItem('token', d.access_token); token=d.access_token; init(); }
            else alert(d.error);
        }

        async function init() {
            document.getElementById('auth-section').classList.add('d-none');
            document.getElementById('app-section').classList.remove('d-none');
            loadData();
        }

        async function loadData() {
            const [pRes, cRes, sRes] = await Promise.all([
                fetch(`${API}/products`, {headers:{'Authorization':token}}),
                fetch(`${API}/customers`, {headers:{'Authorization':token}}),
                fetch(`${API}/stats`, {headers:{'Authorization':token}})
            ]);
            prods = await pRes.json();
            custs = await cRes.json();
            const stats = await sRes.json();
            
            document.getElementById('kpi-sales').innerText = "â‚ª" + stats.total_sales.toLocaleString();
            document.getElementById('kpi-profit').innerText = "â‚ª" + stats.total_profit.toLocaleString();
            
            renderProds(prods);
        }

        function renderProds(list) {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = list.map(p => `
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="stat-card p-3 d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold text-dark">${p.name}</div>
                            <div class="text-muted small">${p.sku || '-'} | ××œ××™: ${p.quantity}</div>
                            <div class="text-primary fw-bold mt-1">â‚ª${p.sell_price}</div>
                        </div>
                        <button class="btn btn-outline-primary rounded-circle" style="width:40px;height:40px" onclick="addCart(${p.id})"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function addCart(pid) {
            const p = prods.find(x=>x.id==pid);
            if(p.quantity <= (cart[pid]||0)) return alert('××™×Ÿ ××¡×¤×™×§ ××œ××™');
            cart[pid] = (cart[pid]||0)+1;
            renderCart();
        }

        function renderCart() {
            let total=0, count=0;
            for(let pid in cart) {
                const p = prods.find(x=>x.id==pid);
                total += p.sell_price * cart[pid];
                count += cart[pid];
            }
            document.getElementById('cart-total').innerText = "â‚ª" + total.toLocaleString();
            document.getElementById('cart-count').innerText = `(${count})`;
            document.getElementById('cart-bar').classList.toggle('visible', count>0);
        }

        function openCheckout() {
            const list = document.getElementById('co-items');
            list.innerHTML = '';
            let total=0;
            for(let pid in cart) {
                const p = prods.find(x=>x.id==pid);
                const sub = p.sell_price * cart[pid];
                total += sub;
                list.innerHTML += `<li class="list-group-item d-flex justify-content-between"><span>${p.name} x${cart[pid]}</span><span>â‚ª${sub}</span></li>`;
            }
            document.getElementById('co-total').innerText = "â‚ª" + total.toLocaleString();
            const sel = document.getElementById('co-cust');
            sel.innerHTML = '<option value="">×œ×œ× ×©×™×•×š (××–×“××Ÿ)</option>' + custs.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
            new bootstrap.Modal(document.getElementById('checkoutModal')).show();
        }

        async function submitOrder() {
            const custId = document.getElementById('co-cust').value;
            const payMethod = document.querySelector('input[name="payment"]:checked').value;
            const items = Object.keys(cart).map(pid => ({product_id: pid, quantity: cart[pid]}));
            
            const res = await fetch(`${API}/orders`, {
                method:'POST',
                headers:{'Content-Type':'application/json','Authorization':token},
                body:JSON.stringify({customer_id: custId, items: items, payment_method: payMethod})
            });

            if(res.ok) {
                const d = await res.json();
                lastOrder = { id: d.order_id, total: document.getElementById('co-total').innerText, items: items };
                cart={}; renderCart();
                bootstrap.Modal.getInstance(document.getElementById('checkoutModal')).hide();
                loadData();
                document.getElementById('rec-oid').innerText = d.order_id;
                new bootstrap.Modal(document.getElementById('receiptModal')).show();
            }
        }

        function shareWhatsApp() {
            let text = `*×§×‘×œ×” ×¢×‘×•×¨ ×”×–×× ×” ${lastOrder.id}* %0A`;
            text += `×¡×”"×› ×œ×ª×©×œ×•×: ${lastOrder.total} %0A------------------%0A`;
            // ×‘×’×¨×¡×” ×××™×ª×™×ª ×›××Ÿ ×©××™× ××ª ×¤×™×¨×•×˜ ×”××•×¦×¨×™×
            text += `×ª×•×“×” ×©×§× ×™×ª ××¦×œ× ×•!`;
            window.open(`https://wa.me/?text=${text}`, '_blank');
        }

        // --- SCANNER ---
        function startScanner() {
            new bootstrap.Modal(document.getElementById('scannerModal')).show();
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
                (decodedText) => {
                    stopScanner();
                    const p = prods.find(x => x.sku === decodedText);
                    if(p) { addCart(p.id); alert(`× ×•×¡×£: ${p.name}`); }
                    else alert('××•×¦×¨ ×œ× × ××¦×');
                    bootstrap.Modal.getInstance(document.getElementById('scannerModal')).hide();
                }
            );
        }
        function stopScanner() { if(html5QrcodeScanner) html5QrcodeScanner.stop(); }

        // --- ANALYTICS ---
        async function loadAnalytics() {
            const res = await fetch(`${API}/analytics`, {headers:{'Authorization':token}});
            const d = await res.json();
            
            document.getElementById('abc-list').innerHTML = d.abc.map(x => 
                `<tr><td>${x.name}</td><td>â‚ª${x.revenue}</td><td><span class="abc-badge-${x.grade}">${x.grade}</span></td></tr>`
            ).join('');

            document.getElementById('forecast-list').innerHTML = d.forecast.map(x => 
                `<li class="list-group-item d-flex justify-content-between text-danger">
                    <span>${x.name}</span>
                    <span class="fw-bold">×™×™×’××¨ ×‘-${x.days_left} ×™××™×</span>
                </li>`
            ).join('');
        }

        function switchTab(t) {
            ['dashboard','analytics','customers','orders'].forEach(x => {
                document.getElementById('tab-'+x).classList.toggle('d-none', x!==t);
                // ×¢×“×›×•×Ÿ ××™×™×§×•×Ÿ ×ª×—×ª×•×Ÿ
                const btn = document.getElementById('btn-'+x);
                if(btn) {
                    if(x===t) btn.classList.add('active'); else btn.classList.remove('active');
                }
            });
            document.getElementById('mobile-title').innerText = document.getElementById('btn-'+t)?.innerText || '×“×©×‘×•×¨×“';
            if(t==='analytics') loadAnalytics();
            if(t==='orders') loadOrders();
        }

        async function loadOrders() {
            const res = await fetch(`${API}/orders`, {headers:{'Authorization':token}});
            const list = await res.json();
            document.getElementById('order-list').innerHTML = list.map(o => `
                <a href="#" class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">×”×–×× ×” #${o.id}</h6>
                        <small>${new Date(o.created_at).toLocaleDateString()}</small>
                    </div>
                    <p class="mb-1">â‚ª${o.total_amount} <span class="badge bg-secondary">${o.payment_method||'Cash'}</span></p>
                    <small>${o.customer_name || '××–×“××Ÿ'}</small>
                </a>
            `).join('');
        }

        // Utils
        function openProdModal(){ new bootstrap.Modal(document.getElementById('prodModal')).show(); }
        async function saveProd(){ /* ×œ×•×’×™×§×” ××§×•×¦×¨×ª ×œ×”×•×¡×¤×” */ }
        function filterProds(){ renderProds(prods.filter(p=>p.name.includes(document.getElementById('search').value) || p.sku.includes(document.getElementById('search').value))); }
        function logout(){ localStorage.clear(); location.reload(); }
    </script>
</body>
</html>
